---
# _post/2015-10-05-raspi-server.html
layout: post
title: Raspberry Pi 2 Type Bでサーバー作り
---
<h2>ラズパイの用意</h2>
<article>
<ol>
<li>ラズパイ用のOS「NOOBS」を<a href="http://raspberrypi.org/downloads/" target="_blank">raspberrypi.org</a>からDLして解凍する。</li>
<li>microSDカードをFAT32でフォーマットする。</li>
<li>解凍したファイルをSDカードにコピーする。</li>
<li>ラズパイにSDカード、キーボード、LANケーブル（またはWiFiドングル）をつないで電源を入れる。</li>
</ol>
</article>

<h2>無線LANの接続</h2>
<article>
<p>　WiFiドングルをラズパイに差す。</p>
<pre>$ifconfig</pre>
<p>このコマンドで、インターフェースを確認する。</p>
<pre>$iwconfig</pre>
<p>このコマンドでWiFi情報を確認できる。</p>
<p>　次のファイルを編集して、ハードウェアインターフェースの設定をする。</p>
<pre>
$sudo vim /etc/network/interfaces

auto lo
iface lo inet loopback

auto eth0
allow-hotplug eth0
iface eth0 inet static
address 192.168.11.2	←your IP
netmask 255.255.255.0	←your subnetmask
gateway 192.168.11.1	←your router IP
dns-nameserver 8.8.8.8 10.255.0.1

auto wlan0
allow-hotplug wlan0
iface wlan0 inet static
address 192.168.11.2	←your IP
netmask 255.255.255.0	←your subnetmask
gateway 192.168.11.1	←your router IP
dns-nameserver 8.8.8.8 10.255.0.1

wpa-conf /etc/wpa_supplicant/wpa_supplicant.conf

auto wlan1
allow-hotplug wlan1
iface wlan0 inet manual
wpa-conf /etc/wpa_supplicant/wpa_supplicant.conf
</pre>
<p>次のコマンド</p>
<pre>$wpa_passphrase "your SSID" "Password"</pre>
<p>で表示された内容をもとに次のファイルの下に追加で記述する。</p>
<pre>
$sudo vim /etc/wpa_supplicant/wpa_supplicant.conf

~~~
network={
	ssid="your SSID"
#psk="Password"
		psk="......."
		key_mgmt=WPA-PSK
		proto=WPA WPA2
		pairwise=CCMP TKIP
		group=CCMP TKIP WEP104 WEP40
}						</pre>
<p>　これでラズパイを再起動すればつながるはず。</p>
</article>

<h2>Webサーバー作り</h2>
<article>
<p>　まずは、ラズパイのローカルIPを固定にする。</p>
<ol>
<li>ラズパイ上でラズパイ自身のローカルIPアドレスを確認しておく。</li>
<pre>$ip addr</pre>
<li>家のルーターの管理設定にログインして、ラズパイのIPの設定を、「自動割り当て」から「手動割り当て」に変更する。</li>
</ol>
<p>　次に、Webサーバーアプリの「Apache2」をインストールする。</p>
<pre>$sudo apt-get install apache2</pre>
<p>　これで、とりあえずはローカルでサーバーとして使うことができる。ローカルネットワークの端末のブラウザでラズパイのローカルIPアドレスを入力すれば、アクセスできる。</p>
</article>

<h2>サーバーを外部へ公開する</h2>
<article>
<p>　今の状態では、LANからしかサーバーにアクセスできない。これを外のネットワークからでもアクセスできるようにする。</p>
<p>　まず、家のルーターから外への接続用のポートを開放する。</p>
<ol>
<li>ルーターの管理設定に入る。</li>
<li>ルータ設定のポート変換を選ぶ</li>
<li>ポート変換の新規追加で、LAN側IPアドレスをラズパイのローカルIPアドレスに、LAN側ポートを80にする。</li>
<li>同じように22ポートも開放する。（80はHTTP用、22はSSH用である）</li>
<li>ラズパイをDMZ(非武装地帯)に置くことですべてのポートを開放することができるが、ファイアウォールなどを適切に設定して、使わないポートをふさがなくてはならない。グローバルからローカルに入るとき、ルーターのファイアウォールによって守られているがDMZはその外にある。したがって、ラズパイは破壊されやすくなるが、たとえラズパイが破壊されてもローカルまで破壊されることは少なくなる。</li>
<li>ポートの開放状況は以下のコマンドで確認できる。<pre>$nmap</pre></li>
</ol>
<p>　次に、<a href="http://www.ugtop.com/spill.shtml" target="_blank">確認くん</a>により自分の家のグローバルIPアドレスを確認する。家のネットワークからアクセスしましょう。</p>
<p>　これで、適当なブラウザから、このグローバルIPアドレスにアクセスすれば、どこからでもラズパイのWebサーバーにアクセスできる。（ドメインはまだ取得していないので、IPアドレスを直打ちして接続している）</p>
</article>

<h2>独自ドメインを取得する</h2>
<article>
<p>　ポートの開放により外部からサーバーにアクセスできるようになった。しかし、今のままではIPアドレスにアクセスなのでいまいち。そこで次は独自ドメインを取得して自分専用のURLをGETする。</p>
<p>　ドメイン取得をできるサイトはいくつかあるが、ネット上で評価のよかった「<a href="http://www.muumuudomain.com" target="_blank">ムームードメイン</a>」で取得した。[.top]一番安くて、なんと77円＋税/年！とても安い。</p>
</article>

<h2>DNSサーバーとは</h2>
<article>
<p>　独自ドメインを取得しましたが、取得したドメインはまだラズパイのIPアドレス（家のグローバルIPアドレス）に紐ついていません。それを紐つけるのがDNSサーバーです。DNS情報はあまりにも多いので、一つのDNSサーバーで管理しているわけではなく、ネット上に無数に散らばっています。したがってあるDNSサーバーに登録すれば、いろいろなDNSサーバーを経由して目的のIPアドレスを知ることができます。DNS情報のことをレコードと言い、以下に分類されます。</p>
<ul>
<li>Aレコード：ドメイン名からIPアドレスを返す（正引き）</li>
<li>PTRレコード：IPアドレスからドメイン名を返す（逆引き）</li>
<li>CNAMEレコード：ドメイン名から別のドメイン名を返す</li>
<li>NSレコード：「再起問い合わせ」や「反復問い合わせ」の際に、「ここへ問い合わせよ」と教えてくれる</li>
</ul>
</article>

<h2>MyDNS.jpの登録</h2>
<article>
<p>　普通、グローバルIPアドレスは動的に割り当てられるので、それとホスト名（ドメイン名）を動的に登録・管理するのがDDNSです。無料DDNSのひとつに<a href="http://www.mydns.jp" target="_blank">MyDNS.jp</a>があるので、今回はそれを使います。まずは会員登録をします。そして「IP ADDR DIRECT」のところに家のグローバルIPアドレスを記載します。次に、「DOMAIN INFO」のところに自分の取得したホスト名（独自ドメイン）を記載します。欄が多いですが、それ以外は何も書かなくて大丈夫です。</p>
</article>

<h2>DNSの浸透時間</h2>
<article>
<p>　ここまでの作業をすれば、取得した独自ドメインをブラウザのURLに書くだけで自分のサーバーにつなことができます。しかし、すぐにつなぐことはできません。先にも書いたようにDNSサーバーはネット上に無数に散らばっていますので、最初にアクセスしたDNSが自分のドメインとIPの関連付けを持っているとは限りません。DNSからDNSへと広がっていき、次第に世界中からアクセスできるようになります。</p>
</article>

<h2>動的IPの自動更新</h2>
<article>
<p>　ムームードメインで、独自ドメインを取得した。MyDNS.jpにも登録した。次にやることは、動的IPアドレスの自動更新である。定期的にグローバルIPの変更をチェックして<a href="http://www.mydns.jp" target="_blank">MyDNS.jp</a>に通知をすればよい。それには以下のコマンドを実行する。</p>
<pre>$ wget -O- 'http://mydnsXXXXXX:PASSWORD@www.mydns.jp/login.html'</pre>
<p>これをcronなどを使って定期的に実行すればよい。</p>
</article>


